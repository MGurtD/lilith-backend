# Testing Guide: Auto-Generate Production Parts Feature

## Overview

This feature automatically generates `ProductionPart` records when a `WorkOrderPhase` is closed. The generation happens asynchronously in the background without blocking the user.

## Prerequisites

1. **Database migration applied**
   ```bash
   dotnet ef database update --project src/Infrastructure/ --startup-project src/Infrastructure/
   ```

2. **Backend running**
   ```bash
   dotnet run --project src/Api/
   ```
   
3. **Swagger UI available** at `https://localhost:5001/swagger`

4. **Test data setup**:
   - At least one `WorkOrder` with phases
   - At least one `Workcenter` with an active `WorkcenterShift`
   - At least one `Operator` clocked in
   - Phase loaded onto the workcenter (`WorkOrderPhaseIn`)

## Test Scenarios

### Scenario 1: Basic Phase Close (Happy Path)

**Goal**: Verify that closing a phase automatically generates ProductionParts

**Steps**:

1. **Setup Phase**:
   - Load a phase onto a workcenter: `POST /api/WorkcenterShift/WorkOrderPhase/In`
     ```json
     {
       "workcenterId": "{guid}",
       "workOrderPhaseId": "{guid}",
       "timestamp": "2026-02-14T10:00:00Z"
     }
     ```
   - Clock in an operator: `POST /api/WorkcenterShift/Operator/In`
   - Optionally update quantities: `PUT /api/WorkcenterShift/UpdateQuantities`
     ```json
     {
       "workcenterId": "{guid}",
       "workOrderPhaseId": "{guid}",
       "quantityOk": 10,
       "quantityKo": 0
     }
     ```

2. **Close the Phase**:
   - `POST /api/WorkcenterShift/WorkOrderPhase/Out`
     ```json
     {
       "workcenterId": "{guid}",
       "workOrderPhaseId": "{guid}",
       "timestamp": "2026-02-14T11:30:00Z",
       "workOrderStatusId": "{guid-for-Tancada}"
     }
     ```
   - ✅ **Expected**: HTTP 200 returned immediately (< 100ms)

3. **Verify Background Generation** (wait 2-5 seconds):
   - `GET /api/ProductionPart` or query by WorkOrderPhaseId
   - ✅ **Expected**: New `ProductionPart` records created with:
     - `IsAutoGenerated = true`
     - `WorkOrderPhaseId` = the closed phase
     - `OperatorId` = the operator who was clocked in
     - `WorkcenterTime` = elapsed minutes from phase in to phase out
     - `OperatorTime` = elapsed minutes / concurrent operators
     - `Quantity` = sum of `QuantityOk` from shift details
     - `OperatorHourCost` and `MachineHourCost` = time-weighted averages from shift details

4. **Check Logs**:
   - Look for: `"Generats {Count} tiquets de produccio per la fase {PhaseId}"`
   - ✅ **Expected**: No errors, count matches expected parts

5. **Verify WorkOrder Totals Updated**:
   - `GET /api/WorkOrder/{workOrderId}`
   - ✅ **Expected**: `MachineCost`, `OperatorCost`, `MachineTime`, `OperatorTime`, `TotalQuantity` updated

---

### Scenario 2: Phase Reopen and Re-Close

**Goal**: Verify that reopening and re-closing regenerates parts correctly

**Steps**:

1. **After Scenario 1**, note the ProductionPart IDs that were created

2. **Reopen the Phase**:
   - Load the phase again: `POST /api/WorkcenterShift/WorkOrderPhase/In`
   - Clock in an operator
   - Wait some time (to create new shift detail records)

3. **Close the Phase Again**:
   - `POST /api/WorkcenterShift/WorkOrderPhase/Out`

4. **Verify**:
   - The old auto-generated ProductionParts (from step 1) are **deleted**
   - New ProductionParts are created that aggregate **ALL** shift details (from both open/close cycles)
   - ✅ **Expected**: WorkOrder totals are correct (not doubled)

---

### Scenario 3: Multiple Operators, Multiple Machine Statuses

**Goal**: Verify grouping logic creates separate ProductionParts per (MachineStatus, Operator) combination

**Setup**:
- Phase has 2 WorkOrderPhaseDetails with different MachineStatusIds (e.g., "Producció", "Preparació")
- 2 operators clocked in at different times
- Change machine status during the phase: `POST /api/WorkcenterShift/ChangeStatus`

**Expected**:
- Up to 4 ProductionParts generated (2 statuses × 2 operators), but only for combinations that actually occurred

---

### Scenario 4: External Work Phase (Should Skip)

**Goal**: Verify that phases with `IsExternalWork = true` do NOT generate parts

**Steps**:
1. Mark a phase as external work: `phase.IsExternalWork = true`
2. Load and close the phase
3. **Expected**: No ProductionParts generated, log shows: `"Fase {PhaseId} es treball extern, no es generen tiquets"`

---

### Scenario 5: Manual Parts Coexist

**Goal**: Verify that manually created ProductionParts are not deleted

**Steps**:
1. Close a phase (auto-generates parts)
2. Manually create a ProductionPart: `POST /api/ProductionPart` with `IsAutoGenerated = false`
3. Reopen and re-close the phase
4. **Expected**: 
   - Auto-generated parts are regenerated
   - Manual part (IsAutoGenerated=false) is **NOT** deleted

---

### Scenario 6: Phase with No Operator (Unmanned)

**Goal**: Verify that shift details without an operator are skipped

**Steps**:
1. Load a phase without clocking in an operator
2. Close the phase
3. **Expected**: No ProductionParts generated (or only for operators who were clocked in)

---

### Scenario 7: App Restart During Phase Close

**Goal**: Verify graceful handling of in-memory queue loss

**Steps**:
1. Close a phase
2. Immediately kill the backend process (`Ctrl+C`) before background job completes
3. Restart the backend
4. **Expected**: ProductionParts may not be generated (queue is in-memory, not persisted)
5. **Workaround**: Re-close the phase or manually create parts

---

## Monitoring & Debugging

### Check Background Service Status

**Logs on startup**:
```
ProductionPartGeneratorService iniciat
```

**Logs on phase close**:
```
Generats {N} tiquets de produccio per la fase {PhaseId}
```

**Error logs**:
```
Error generant tiquets de produccio per la fase {PhaseId}
```

### Database Queries

**Find auto-generated parts**:
```sql
SELECT * FROM "ProductionParts" WHERE "IsAutoGenerated" = true;
```

**Find parts for a specific phase**:
```sql
SELECT * FROM "ProductionParts" WHERE "WorkOrderPhaseId" = '{guid}';
```

**Check shift details for a phase**:
```sql
SELECT * FROM "WorkcenterShiftDetails" 
WHERE "WorkOrderPhaseId" = '{guid}' AND "EndTime" IS NOT NULL;
```

### Swagger Endpoints

- **Phase In**: `POST /api/WorkcenterShift/WorkOrderPhase/In`
- **Phase Out**: `POST /api/WorkcenterShift/WorkOrderPhase/Out`
- **Operator In**: `POST /api/WorkcenterShift/Operator/In`
- **List ProductionParts**: `GET /api/ProductionPart`
- **Delete ProductionPart**: `DELETE /api/ProductionPart/{id}`

---

## Common Issues & Troubleshooting

| Issue | Cause | Fix |
|-------|-------|-----|
| No parts generated | Phase is external work | Check `phase.IsExternalWork` |
| No parts generated | No operator clocked in | Shift details without `OperatorId` are skipped |
| No parts generated | No WorkOrderPhaseDetails | Phase must have at least one detail with `MachineStatusId` |
| Parts duplicated after reopen | Old parts not deleted | Check logs for deletion step, verify `IsAutoGenerated` flag |
| Wrong costs | WorkcenterShiftDetail costs are 0 | Check `WorkcenterCost` and `OperatorCost` setup in shift details |
| Background service not running | Not registered in DI | Verify `services.AddHostedService<ProductionPartGeneratorService>()` |

---

## Performance Verification

### Test Under Load

1. Close 10 phases simultaneously
2. **Expected**: All HTTP responses return immediately
3. Background jobs process sequentially (one at a time due to `SingleReader = true`)
4. Check logs for timing

### Memory Usage

- In-memory channel is unbounded (no backpressure)
- Each queued message is ~48 bytes (3 Guids + DateTime)
- 1000 queued jobs = ~48 KB memory

---

## Rollback Plan

If issues arise in production:

1. **Stop auto-generation**:
   - Comment out the `EnqueueAsync` call in `WorkcenterShiftDetailService.WorkOrderPhaseOut` (line 414)
   - Redeploy

2. **Delete bad auto-generated parts**:
   ```sql
   DELETE FROM "ProductionParts" WHERE "IsAutoGenerated" = true;
   ```

3. **Revert migration**:
   ```bash
   dotnet ef migrations remove --project src/Infrastructure/
   ```

---

## Next Steps

- Test in a **staging environment** with real production data
- Monitor logs for the first week
- Consider adding a feature flag to enable/disable auto-generation per site/workcenter
- Consider adding admin UI to manually trigger regeneration for a closed phase
